services:
  # Local Postgres (TCP on 5432)
  postgres:
    image: postgres:17
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: main
    ports:
      - "5432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d main"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Inngest Dev Server on 8288
  # Next.js runs on the HOST at :3000 by default; the dev server reaches it via host.docker.internal
  inngest:
    image: inngest/inngest:latest
    command: >
      inngest dev -u http://host.docker.internal:${PORT:-3000}/api/inngest
    ports:
      - "8288:8288"

  # ngrok tunnel to expose local Next.js dev server to the internet for webhooks (e.g., Polar)
  # Requires NGROK_AUTHTOKEN in .env.local (get from https://dashboard.ngrok.com)
  # Optional: Set NGROK_URL for stable/persistent domain (example: NGROK_URL=my-name.ngrok-free.app)
  ngrok:
    image: ngrok/ngrok:latest
    volumes:
      - ./scripts/ngrok-entrypoint.sh:/entrypoint.sh:ro
    entrypoint: ["/bin/sh", "/entrypoint.sh"]
    command: ["start", "--all"]
    ports:
      - "4040:4040" # ngrok web interface
    environment:
      NGROK_AUTHTOKEN: ${NGROK_AUTHTOKEN:-}
      NGROK_URL: ${NGROK_URL:-}
      NGROK_TARGET_PORT: ${PORT:-3000}

volumes:
  pg_data:
